<!-- 
{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Online Test - {{ paper.title }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />

    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/loader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/skulpt/2.0.0/skulpt.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/skulpt/2.0.0/skulpt-stdlib.min.js"></script>

    <script>
      (function () {
        const windowName = "dedicatedAssessmentWindow";

        if (window.name !== windowName && !window.opener) {
          const url = window.location.href;

          const newWindow = window.open(
            url,
            windowName,
            "width=" +
              screen.availWidth +
              ",height=" +
              screen.availHeight +
              ",resizable=yes,scrollbars=yes,location=no,menubar=no,toolbar=no,status=no"
          );

          if (newWindow) {
            setTimeout(function () {
              window.close();
            }, 50);

            document.body.style.display = "none";
            return;
          }
        }
      })();
    </script>
    <script>
      function noBack() {
        window.history.forward();
      }

      window.history.forward();

      let isNavigating = false;

      document.addEventListener("DOMContentLoaded", function () {
        window.addEventListener("popstate", function (event) {
          alert(
            "âš ï¸ WARNING! Navigation Attempt Detected. The Back/Forward button is disabled for this assessment. Repeated attempts to navigate away may result in auto-submission."
          );

          isNavigating = true;
          noBack();

          setTimeout(() => {
            isNavigating = false;
          }, 500);
        });
      });
    </script>

    <script>
      let editorInstances = {};
      let tabChangeCount = 0;
      const MAX_TAB_CHANGES = 3;
      let submissionLocked = false;

      function lockAndAutoSubmit(reason) {
        if (submissionLocked) return;
        submissionLocked = true;

        if (window.pollingInterval) clearInterval(window.pollingInterval);

        document.title = "Assessment Submitted!";

        const form = document.getElementById("assessment-form");
        const submitButton = form.querySelector('button[type="submit"]');

        const message =
          reason === "time_up"
            ? "ðŸš¨ Time is up! Your assessment is being automatically submitted by the server."
            : "ðŸš¨ FINAL WARNING: You have exceeded the tab change limit. Your assessment is being automatically submitted.";

        if (submitButton) {
          submitButton.disabled = true;
          submitButton.textContent = "Auto-Submitting... ðŸš«";
          submitButton.classList.remove("bg-green-600", "hover:bg-green-700");
          submitButton.classList.add("bg-red-800", "cursor-not-allowed");
        }

        const timerElement = document.getElementById("timer");
        if (timerElement) {
          timerElement.textContent = "TIME UP";
          timerElement.classList.remove(
            "bg-red-600",
            "bg-yellow-500",
            "text-gray-800"
          );
          timerElement.classList.add("bg-red-800", "text-white");
        }

        alert(message);

        document.querySelectorAll(".code-editor").forEach((editorContainer) => {
          const questionId = editorContainer.id.replace("editor-", "");
          const textarea = document.getElementById(`textarea-${questionId}`);
          const editor = editorInstances[questionId];
          if (editor) {
            textarea.value = editor.getValue();
          }
        });

        form.submit();
      }

      function handleVisibilityChange() {
        if (window.isNavigating || submissionLocked) {
          return;
        }

        const originalTitle = "Online Test - {{ paper.title }}";

        if (document.hidden) {
          document.title = "Breakup";

          tabChangeCount++;

          if (tabChangeCount <= MAX_TAB_CHANGES) {
            alert(
              `âš ï¸ WARNING! Tab Switched. You have ${
                MAX_TAB_CHANGES - tabChangeCount
              } warnings remaining.`
            );
          } else {
            lockAndAutoSubmit("tab_switch");
          }
        } else {
          document.title = "Patch Up";
          setTimeout(() => {
            if (!submissionLocked) {
              document.title = originalTitle;
            }
          }, 1000);
        }
      }

      document.addEventListener("visibilitychange", handleVisibilityChange);
    </script>

    <script>
      const OFFLINE_DIALOGUE_ID = "offline-dialogue";

      function showOfflineDialogue() {
        const dialogue = document.getElementById(OFFLINE_DIALOGUE_ID);
        if (dialogue) {
          dialogue.classList.remove("hidden");
        }
      }

      function hideOfflineDialogue() {
        const dialogue = document.getElementById(OFFLINE_DIALOGUE_ID);
        if (dialogue) {
          dialogue.classList.add("hidden");
        }
      }

      function checkConnectionAndHide() {
        if (navigator.onLine) {
          hideOfflineDialogue();
        } else {
          alert(
            "Still offline. Please check your network cables or Wi-Fi connection."
          );
        }
      }

      function handleOnlineStatus() {
        if (navigator.onLine) {
          hideOfflineDialogue();
          console.log("Internet connection restored.");
        } else {
          showOfflineDialogue();
          console.log("Internet connection lost!");
        }
      }

      window.addEventListener("online", handleOnlineStatus);
      window.addEventListener("offline", handleOnlineStatus);

      document.addEventListener("DOMContentLoaded", handleOnlineStatus);
    </script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              "theme-primary": "#736b8e",
              "theme-dark": "#5f5778",
              "theme-light": "#e5e3e9",
              "gray-text": "#6B7280",
            },
          },
        },
      };
    </script>
    <style type="text/tailwindcss">
      body {
        font-family: "Inter", sans-serif;
        background-color: #f4f7f9;
      }

      .question-card {
        transition: box-shadow 0.2s;
      }

      .question-card:hover {
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
      }

      .answer-input {
        @apply w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-theme-primary;
      }

      .code-editor {
        min-height: 250px;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
      }

      .question-btn {
        @apply w-10 h-10 rounded flex items-center justify-center font-semibold text-sm cursor-pointer transition-all;
      }

      /* COLORS configured here */
      .question-answered {
        @apply bg-green-600 text-white border-transparent;
      }

      .question-current {
        @apply bg-blue-600 text-white border-transparent;
      }

      .question-not-answered {
        @apply bg-red-600 text-white border-transparent;
      }

      .question-marked {
        @apply bg-yellow-500 text-gray-900 border-transparent;
      }

      /* INITIAL GREY COLOR */
      .question-not-visited {
        @apply bg-gray-300 text-gray-800 border border-gray-300;
      }

      .legend-item {
        @apply flex items-center space-x-2 text-sm;
      }

      .legend-box {
        @apply w-6 h-6 rounded;
      }
    </style>
  </head>

  <body
    class="text-gray-800"
    onload="noBack()"
    onpageshow="if (event.persisted) noBack();"
  >
    <div
      id="offline-dialogue"
      class="fixed inset-0 z-50 bg-gray-900 bg-opacity-80 flex items-center justify-center hidden"
      role="alert"
      aria-modal="true"
      aria-labelledby="dialog-title"
    >
      <div
        class="bg-white rounded-lg shadow-xl p-8 max-w-lg w-full transform transition-all duration-300 scale-100"
      >
        <div class="text-center">
          <i class="fas fa-wifi fa-3x text-red-600 mb-4"></i>
          <h3 id="dialog-title" class="text-2xl font-bold text-gray-900 mb-2">
            You Are Not Connected to the Internet
          </h3>
          <p id="dialog-message" class="text-gray-600 mb-6">
            Please restore your connection immediately. Assessment integrity
            requires a stable network.
          </p>
          <button
            onclick="checkConnectionAndHide()"
            class="w-full bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors focus:outline-none"
          >
            Check Connection Again
          </button>
        </div>
      </div>
    </div>

    <div class="min-h-screen flex flex-col">
      <header class="bg-gradient-to-r from-gray-100 to-gray-200 shadow-md">
        <div class="max-w-full mx-auto px-6 py-4 flex justify-between items-center">
          <h1 class="text-xl font-bold text-gray-800">
            Online Test - {{ paper.title }}
          </h1>

          <div class="flex items-center space-x-6">
            <div class="text-right">
              <div class="text-xs text-gray-600 mb-1">Time Left</div>
              <div
                class="bg-white border-2 border-gray-300 text-gray-800 font-bold py-2 px-4 rounded text-lg"
                id="timer"
              >
                00:00:00
              </div>
            </div>
          </div>
        </div>
      </header>

      <main class="flex-1 flex overflow-hidden">
        <form
          method="post"
          action="{% url 'test:user_test' link_id=link_id %}"
          id="assessment-form"
          class="flex-1 flex"
        >
          {% csrf_token %}
          
          <div class="flex-1 bg-white overflow-y-auto p-6">
            <div id="questions-container">
              {% for section in sections_list %}
                {% for q in section.questions %}
                  <div 
                    class="question-block" 
                    id="question-{{ q.id }}" 
                    data-section="{{ section.title }}"
                    data-question-index="{{ forloop.counter }}"
                    style="display: none;">
                    
                    <div class="mb-4">
                      <h2 class="text-lg font-bold text-gray-700 mb-2">{{ section.title }}</h2>
                      <div class="text-sm text-gray-600">Question {{ forloop.counter }}</div>
                    </div>

                    <div class="bg-gray-50 p-5 rounded-lg border border-gray-200 mb-6">
                      <p class="text-base leading-relaxed text-gray-800">
                        {{ q.text | safe }}
                      </p>
                    </div>

                    <div class="mb-6">
                      {% if q.type == 'MCQ' %}
                        <div class="space-y-3">
                          {% for option in q.options %}
                          <label class="flex items-start p-4 border-2 border-gray-200 rounded-lg hover:border-blue-400 hover:bg-blue-50 cursor-pointer transition-all">
                            <input
                              type="radio"
                              name="question_{{ q.id }}"
                              value="{{ option }}"
                              class="mt-1 h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500"
                              onchange="markQuestionAsAnswered({{ q.id }})"
                            />
                            <span class="ml-3 text-sm text-gray-700 flex-1">{{ option }}</span>
                          </label>
                          {% endfor %}
                        </div>
                      {% elif q.type == 'CODE' %}
                        <p class="text-sm text-gray-600 mb-3">
                          Write, run and submit your code below:
                        </p>

                        <div class="mb-3">
                          <label
                            for="language-selector-{{ q.id }}"
                            class="text-xs font-semibold text-gray-700 mr-2"
                            >Select Language:</label
                          >
                          <select
                            id="language-selector-{{ q.id }}"
                            class="p-2 border border-gray-300 rounded-md text-sm"
                            onchange="changeLanguage({{ q.id }}, this.value)"
                          >
                            
                            <option value="javascript">JavaScript</option>
                            <option value="java">Java</option>
                            <option value="cpp">C++</option>
                            <option value="c">C</option>
                            <option value="sql">SQL</option>
                          </select>
                        </div>
                        
                        <div
                          id="editor-{{ q.id }}"
                          class="code-editor mb-3"
                          data-language="python"
                        ></div>

                        <textarea
                          name="question_{{ q.id }}"
                          id="textarea-{{ q.id }}"
                          class="hidden"
                        ></textarea>

                        <div
                          id="output-{{ q.id }}"
                          class="hidden mt-3 p-3 text-sm rounded-lg whitespace-pre-wrap font-mono"
                        ></div>

                        <div class="mt-3 flex space-x-3">
                          <button
                            type="button"
                            id="run-btn-{{ q.id }}"
                            onclick="runCode({{ q.id }})"
                            class="bg-blue-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors text-sm"
                          >
                            <i class="fas fa-play mr-1"></i> Run Code
                          </button>
                        </div>

                      {% else %}
                        <textarea
                          name="question_{{ q.id }}"
                          id="textarea-{{ q.id }}"
                          rows="6"
                          placeholder="Type your detailed answer here..."
                          class="answer-input resize-y"
                          onchange="markQuestionAsAnswered({{ q.id }})"
                        ></textarea>
                      {% endif %}
                    </div>

                    <div class="flex justify-between items-center pt-4 border-t border-gray-200">
                      <button
                        type="button"
                        onclick="markForReviewCurrent()"
                        id="mark-review-btn-{{ q.id }}"
                        class="bg-purple-600 text-white font-medium py-2 px-6 rounded-lg hover:bg-purple-700 transition-colors"
                      >
                        Mark for review
                      </button>

                      <div class="flex space-x-3">
                        <button
                          type="button"
                          onclick="previousQuestion()"
                          class="bg-gray-500 text-white font-medium py-2 px-6 rounded-lg hover:bg-gray-600 transition-colors"
                        >
                          Previous
                        </button>
                        <button
                          type="button"
                          onclick="nextQuestion()"
                          class="bg-blue-600 text-white font-medium py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors"
                        >
                          Next
                        </button>
                      </div>
                    </div>
                  </div>
                {% endfor %}
              {% endfor %}
            </div>
          </div>

          <div class="w-80 bg-gray-50 border-l border-gray-200 overflow-y-auto p-6">
            {% for section in sections_list %}
            <div class="mb-6">
              <h3 class="font-bold text-gray-800 mb-3 text-sm uppercase tracking-wide">{{ section.title }}</h3>
              <div class="grid grid-cols-5 gap-2 mb-4">
                {% for q in section.questions %}
                <div
                  class="question-btn question-not-visited"
                  id="palette-btn-{{ q.id }}"
                  data-question-id="{{ q.id }}"
                  onclick="goToQuestion({{ q.id }})"
                >
                  {{ forloop.counter }}
                </div>
                {% endfor %}
              </div>
            </div>
            {% endfor %}

            <div class="mt-6 pt-4 border-t border-gray-300">
              <h4 class="font-bold text-gray-700 mb-4 text-sm">Question Summary</h4>
              <div class="space-y-3 mb-4">
                <div class="flex justify-between items-center">
                  <div class="flex items-center space-x-2">
                    <div class="w-5 h-5 rounded bg-green-600"></div>
                    <span class="text-sm text-gray-700">Answered</span>
                  </div>
                  <span id="count-answered" class="font-bold text-gray-800 text-sm">0</span>
                </div>
                
                <div class="flex justify-between items-center">
                  <div class="flex items-center space-x-2">
                    <div class="w-5 h-5 rounded bg-red-600"></div>
                    <span class="text-sm text-gray-700">Not Answered</span>
                  </div>
                  <span id="count-not-answered" class="font-bold text-gray-800 text-sm">0</span>
                </div>
                
                <div class="flex justify-between items-center">
                  <div class="flex items-center space-x-2">
                    <div class="w-5 h-5 rounded bg-gray-300 border border-gray-400"></div>
                    <span class="text-sm text-gray-700">Not Visited</span>
                  </div>
                  <span id="count-not-visited" class="font-bold text-gray-800 text-sm">0</span>
                </div>
                
                <div class="flex justify-between items-center">
                  <div class="flex items-center space-x-2">
                    <div class="w-5 h-5 rounded bg-yellow-500"></div>
                    <span class="text-sm text-gray-700">Marked for Review</span>
                  </div>
                  <span id="count-marked" class="font-bold text-gray-800 text-sm">0</span>
                </div>
                
                <div class="flex justify-between items-center">
                  <div class="flex items-center space-x-2">
                    <div class="w-5 h-5 rounded bg-blue-600"></div>
                    <span class="text-sm text-gray-700">Current</span>
                  </div>
                  <span id="count-current" class="font-bold text-gray-800 text-sm">0</span>
                </div>
              </div>
            </div>

            <div class="mt-6">
              <button
                type="submit"
                class="w-full bg-green-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-green-700 transition-colors shadow-lg"
              >
                Submit Test
              </button>
            </div>
          </div>
        </form>
      </main>
    </div>

    <script>
      // --- Enhanced LocalStorage Functions for Answers & States ---
      const STORAGE_KEY = `test_states_{{ link_id }}`;
      const ANSWERS_STORAGE_KEY = `test_answers_{{ link_id }}`;

      function saveStatesToLocalStorage() {
        try {
          const statesToSave = {};
          allQuestionIds.forEach(qId => {
            statesToSave[qId] = questionStates[qId];
          });
          localStorage.setItem(STORAGE_KEY, JSON.stringify(statesToSave));
          console.log('âœ“ Question states saved to LocalStorage');
        } catch (e) {
          console.error('Error saving states to LocalStorage:', e);
        }
      }

      function loadStatesFromLocalStorage() {
        try {
          const savedStates = localStorage.getItem(STORAGE_KEY);
          if (savedStates) {
            const parsedStates = JSON.parse(savedStates);
            allQuestionIds.forEach(qId => {
              if (parsedStates[qId]) {
                questionStates[qId] = parsedStates[qId];
              }
            });
            console.log('âœ“ Question states loaded from LocalStorage');
            return true;
          }
        } catch (e) {
          console.error('Error loading states from LocalStorage:', e);
        }
        return false;
      }

      function saveAnswersToLocalStorage() {
        try {
          const answersToSave = {};
          
          allQuestionIds.forEach(qId => {
            // Save MCQ answers
            const radioInput = document.querySelector(`input[name="question_${qId}"]:checked`);
            if (radioInput) {
              answersToSave[qId] = {
                type: 'mcq',
                value: radioInput.value
              };
            }
            
            // Save textarea answers (both regular and code editors)
            const textarea = document.querySelector(`textarea[name="question_${qId}"]`);
            if (textarea && textarea.value && !editorInstances[qId]) {
              // Only save textarea if it's not a code editor textarea
              answersToSave[qId] = {
                type: 'textarea',
                value: textarea.value
              };
            }
            
            // Save code editor answers
            const editor = editorInstances[qId];
            if (editor) {
              answersToSave[qId] = {
                type: 'code',
                value: editor.getValue()
              };
            }
          });
          
          localStorage.setItem(ANSWERS_STORAGE_KEY, JSON.stringify(answersToSave));
          console.log('âœ“ Answers saved to LocalStorage - Total:', Object.keys(answersToSave).length);
        } catch (e) {
          console.error('Error saving answers to LocalStorage:', e);
        }
      }

      function loadAnswersFromLocalStorage() {
        try {
          const savedAnswers = localStorage.getItem(ANSWERS_STORAGE_KEY);
          if (savedAnswers) {
            const parsedAnswers = JSON.parse(savedAnswers);
            
            // Restore answers with proper delays
            Object.keys(parsedAnswers).forEach(qId => {
              const answer = parsedAnswers[qId];
              
              try {
                if (answer.type === 'mcq') {
                  const radioInput = document.querySelector(`input[name="question_${qId}"][value="${answer.value}"]`);
                  if (radioInput) {
                    radioInput.checked = true;
                  }
                } else if (answer.type === 'textarea') {
                  const textarea = document.querySelector(`textarea[name="question_${qId}"]`);
                  if (textarea && !editorInstances[qId]) {
                    textarea.value = answer.value;
                  }
                } else if (answer.type === 'code') {
                  const editor = editorInstances[qId];
                  if (editor) {
                    editor.setValue(answer.value);
                  }
                }
              } catch (err) {
                console.error(`Error restoring answer for question ${qId}:`, err);
              }
            });
            
            console.log('âœ“ Answers restored from LocalStorage - Total:', Object.keys(parsedAnswers).length);
            return true;
          }
        } catch (e) {
          console.error('Error loading answers from LocalStorage:', e);
        }
        return false;
      }

      function clearLocalStorage() {
        try {
          localStorage.removeItem(STORAGE_KEY);
          localStorage.removeItem(ANSWERS_STORAGE_KEY);
          console.log('âœ“ LocalStorage cleared - Test submitted');
        } catch (e) {
          console.error('Error clearing LocalStorage:', e);
        }
      }

      // --- Question Navigation State ---
      let currentQuestionId = null;
      let questionStates = {};
      let allQuestionIds = [];

      // Initialize question states
      {% for section in sections_list %}
        {% for q in section.questions %}
          allQuestionIds.push({{ q.id }});
          questionStates[{{ q.id }}] = {
            answered: false,
            marked: false,
            visited: false
          };
        {% endfor %}
      {% endfor %}

      function goToQuestion(questionId) {
        document.querySelectorAll('.question-block').forEach(block => {
          block.style.display = 'none';
        });

        const questionBlock = document.getElementById(`question-${questionId}`);
        if (questionBlock) {
          questionBlock.style.display = 'block';
          currentQuestionId = questionId;
          questionStates[questionId].visited = true;
          saveStatesToLocalStorage();
          updateQuestionPalette();
          updateNavigationButtons();
          updateQuestionSummary();
          updateMarkReviewButton(questionId);
        }
      }

      function nextQuestion() {
        const currentIndex = allQuestionIds.indexOf(currentQuestionId);
        if (currentIndex < allQuestionIds.length - 1) {
          const nextId = allQuestionIds[currentIndex + 1];
          goToQuestion(nextId);
        }
      }

      function previousQuestion() {
        const currentIndex = allQuestionIds.indexOf(currentQuestionId);
        if (currentIndex > 0) {
          const prevId = allQuestionIds[currentIndex - 1];
          goToQuestion(prevId);
        }
      }

      function updateNavigationButtons() {
        const currentIndex = allQuestionIds.indexOf(currentQuestionId);
        const allQuestionBlocks = document.querySelectorAll('.question-block');
        
        allQuestionBlocks.forEach(block => {
          const prevButtons = block.querySelectorAll('button[onclick^="previousQuestion"]');
          const nextButtons = block.querySelectorAll('button[onclick^="nextQuestion"]');
          
          prevButtons.forEach(btn => {
            if (currentIndex === 0) {
              btn.disabled = true;
              btn.classList.add('opacity-50', 'cursor-not-allowed');
              btn.classList.remove('hover:bg-gray-600');
            } else {
              btn.disabled = false;
              btn.classList.remove('opacity-50', 'cursor-not-allowed');
              btn.classList.add('hover:bg-gray-600');
            }
          });
          
          nextButtons.forEach(btn => {
            if (currentIndex === allQuestionIds.length - 1) {
              btn.disabled = true;
              btn.classList.add('opacity-50', 'cursor-not-allowed');
              btn.classList.remove('hover:bg-blue-700');
            } else {
              btn.disabled = false;
              btn.classList.remove('opacity-50', 'cursor-not-allowed');
              btn.classList.add('hover:bg-blue-700');
            }
          });
        });
      }

      function markQuestionAsAnswered(questionId) {
        questionStates[questionId].answered = true;
        questionStates[questionId].marked = false;
        saveStatesToLocalStorage();
        saveAnswersToLocalStorage();
        updateQuestionPalette();
        updateQuestionSummary();
      }

      function markForReview(questionId) {
        questionStates[questionId].marked = !questionStates[questionId].marked;
        console.log(`Question ${questionId} marked state:`, questionStates[questionId].marked);
        saveStatesToLocalStorage();
        saveAnswersToLocalStorage();
        updateQuestionPalette();
        updateQuestionSummary();
        updateMarkReviewButton(questionId);
      }

      function markForReviewCurrent() {
        if (currentQuestionId) {
          markForReview(currentQuestionId);
        } else {
          console.error('No current question selected');
        }
      }

      function updateMarkReviewButton(questionId) {
        const btn = document.getElementById(`mark-review-btn-${questionId}`);
        if (btn) {
          if (questionStates[questionId].marked) {
            btn.textContent = "Unmark Review";
            btn.classList.remove('bg-purple-600', 'hover:bg-purple-700');
            btn.classList.add('bg-orange-600', 'hover:bg-orange-700');
          } else {
            btn.textContent = "Mark for review";
            btn.classList.remove('bg-orange-600', 'hover:bg-orange-700');
            btn.classList.add('bg-purple-600', 'hover:bg-purple-700');
          }
        }
      }

      function updateQuestionPalette() {
        allQuestionIds.forEach(qId => {
          const btn = document.getElementById(`palette-btn-${qId}`);
          if (btn) {
            btn.classList.remove('question-answered', 'question-current', 'question-not-answered', 'question-marked', 'question-not-visited');
            
            if (qId === currentQuestionId) {
              btn.classList.add('question-current');
            } else if (questionStates[qId].marked) {
              btn.classList.add('question-marked');
            } else if (questionStates[qId].answered) {
              btn.classList.add('question-answered');
            } else if (questionStates[qId].visited) {
              btn.classList.add('question-not-answered');
            } else {
              btn.classList.add('question-not-visited');
            }
          }
        });
      }

      function updateQuestionSummary() {
        let counts = {
          answered: 0,
          notAnswered: 0,
          notVisited: 0,
          marked: 0,
          current: 0
        };

        allQuestionIds.forEach(qId => {
          if (qId === currentQuestionId) {
            counts.current = 1;
            if (questionStates[qId].marked) {
              counts.marked++;
            }
          } else if (questionStates[qId].marked) {
            counts.marked++;
          } else if (questionStates[qId].answered) {
            counts.answered++;
          } else if (questionStates[qId].visited) {
            counts.notAnswered++;
          } else {
            counts.notVisited++;
          }
        });

        const answeredEl = document.getElementById('count-answered');
        const notAnsweredEl = document.getElementById('count-not-answered');
        const notVisitedEl = document.getElementById('count-not-visited');
        const markedEl = document.getElementById('count-marked');
        const currentEl = document.getElementById('count-current');

        if (answeredEl) answeredEl.textContent = counts.answered;
        if (notAnsweredEl) notAnsweredEl.textContent = counts.notAnswered;
        if (notVisitedEl) notVisitedEl.textContent = counts.notVisited;
        if (markedEl) markedEl.textContent = counts.marked;
        if (currentEl) currentEl.textContent = counts.current;
      }

      // --- TIMER LOGIC VARIABLES ---
      let totalSeconds = -1;
      const POLLING_RATE_SECONDS = 15;
      window.pollingInterval = null;
      window.editorInstances = {};

      function formatTime(seconds) {
        if (seconds < 0) seconds = 0;
        let hours = parseInt(seconds / 3600, 10);
        let minutes = parseInt((seconds % 3600) / 60, 10);
        let secs = parseInt(seconds % 60, 10);

        hours = hours < 10 ? "0" + hours : hours;
        minutes = minutes < 10 ? "0" + minutes : minutes;
        secs = secs < 10 ? "0" + secs : secs;

        return hours + ":" + minutes + ":" + secs;
      }

      function updateTimerDisplay(seconds) {
        let timerElement = document.getElementById("timer");
        if (!timerElement) return;

        timerElement.textContent = formatTime(seconds);
        timerElement.classList.remove("text-yellow-600", "text-red-600", "text-gray-800");

        if (seconds <= 60) {
          timerElement.classList.add("text-red-600");
        } else if (seconds <= 300) {
          timerElement.classList.add("text-yellow-600");
        } else {
          timerElement.classList.add("text-gray-800");
        }
      }

      function pollTimeRemaining(linkId, formId) {
        const timeUrl = "{% url 'test:get_time_remaining_api' link_id=link_id %}";
        let timerElement = document.getElementById("timer");

        fetch(timeUrl, {
          method: "GET",
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error("Server Time API response not ok");
            }
            return response.json();
          })
          .then((data) => {
            if (data.error) {
              console.error("Server Time Error:", data.error);
              if (window.pollingInterval) clearInterval(window.pollingInterval);
              if (timerElement) timerElement.textContent = "Error";
              return;
            }

            totalSeconds = data.remaining_seconds;

            if (data.time_up || totalSeconds <= 0) {
              if (window.pollingInterval) clearInterval(window.pollingInterval);
              lockAndAutoSubmit("time_up");
            } else {
              updateTimerDisplay(totalSeconds);
            }
          })
          .catch((error) => {
            console.error("Fetch Error:", error);
            if (timerElement) timerElement.textContent = "Sync Error";
          });
      }

      function outf(text, questionId) {
        const outputElement = document.getElementById(`output-${questionId}`);
        outputElement.textContent += text;
        outputElement.classList.remove("hidden", "bg-red-900", "text-red-300");
        outputElement.classList.add("bg-gray-800", "text-green-300");
      }

      function builtinRead(x) {
        if (Sk.builtinFiles === undefined || Sk.builtinFiles["files"][x] === undefined)
          throw "File not found: '" + x + "'";
        return Sk.builtinFiles["files"][x];
      }

      function runJavaScript(code, questionId, outputElement, runButton) {
        let output = "";
        const originalConsoleLog = console.log;

        console.log = (...args) => {
          output += args.map(String).join(" ") + "\n";
        };

        try {
          new Function(code)();
          outputElement.textContent = output.trim() || "Code executed successfully. No output was printed using console.log.";
          outputElement.classList.remove("bg-gray-700", "text-white", "bg-red-900", "text-red-300");
          outputElement.classList.add("bg-gray-800", "text-green-300");
        } catch (err) {
          outputElement.textContent = "Error:\n" + err.toString();
          outputElement.classList.remove("bg-gray-700", "text-white");
          outputElement.classList.add("bg-red-900", "text-red-300");
        } finally {
          console.log = originalConsoleLog;
          runButton.innerHTML = '<i class="fas fa-play mr-1"></i> Run Code';
          runButton.disabled = false;
        }
      }

      function mockServerRunner(language, outputElement, runButton) {
        outputElement.textContent = `Execution Simulation for ${language.toUpperCase()}:\n\nNOTE: ${language.toUpperCase()} code cannot be executed directly in the browser.\nYour code is saved and will be executed/evaluated on the server upon final submission.`;
        outputElement.classList.remove("bg-gray-700", "text-white", "bg-red-900", "text-red-300");
        outputElement.classList.add("bg-blue-900", "text-blue-300");

        setTimeout(() => {
          runButton.innerHTML = '<i class="fas fa-play mr-1"></i> Run Code';
          runButton.disabled = false;
        }, 500);
      }

      function changeLanguage(questionId, newLanguage) {
        const editor = editorInstances[questionId];
        const editorContainer = document.getElementById(`editor-${questionId}`);

        let monacoLanguage = newLanguage;
        let placeholder = "// Write your code here";

        switch (newLanguage) {
          case "python":
            placeholder = "# Write your Python code here";
            break;
          case "javascript":
            monacoLanguage = "javascript";
            placeholder = "// Write your JavaScript code here";
            break;
          case "java":
            monacoLanguage = "java";
            placeholder = "// Write your Java code here";
            break;
          case "cpp":
          case "c":
            monacoLanguage = "cpp";
            placeholder = "// Write your C/C++ code here";
            break;
          case "sql":
            monacoLanguage = "sql";
            placeholder = "-- Write your SQL query here";
            break;
          default:
            monacoLanguage = "plaintext";
            placeholder = "// Write your code here";
            break;
        }

        if (editor) {
          monaco.editor.setModelLanguage(editor.getModel(), monacoLanguage);
          editorContainer.setAttribute("data-language", newLanguage);

          const currentValue = editor.getValue().trim();
          if (currentValue === "" || currentValue.startsWith("# Write") || currentValue.startsWith("// Write") || currentValue.startsWith("-- Write")) {
            editor.setValue(placeholder);
          }
        }
      }

      function runCode(questionId) {
        const editor = editorInstances[questionId];
        if (!editor) {
          alert("Error: Code editor not initialized.");
          return;
        }

        const code = editor.getValue();
        const outputElement = document.getElementById(`output-${questionId}`);
        const runButton = document.getElementById(`run-btn-${questionId}`);
        const editorContainer = document.getElementById(`editor-${questionId}`);

        const language = editorContainer.getAttribute("data-language") || "python";

        outputElement.textContent = "Running...";
        outputElement.classList.remove("hidden", "bg-red-900", "text-green-300", "bg-blue-900", "text-blue-300");
        outputElement.classList.add("bg-gray-700", "text-white");
        runButton.disabled = true;
        runButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Running...';

        if (language === "javascript") {
          runJavaScript(code, questionId, outputElement, runButton);
          return;
        }

        if (language === "python") {
          Sk.pre = "output-" + questionId;

          Sk.configure({
            output: (text) => outf(text, questionId),
            read: builtinRead,
            execLimit: 5000,
          });

          Sk.misceval
            .asyncToPromise(function () {
              return Sk.importMainWithBody("<stdin>", false, code, true);
            })
            .then(
              function (mod) {
                runButton.innerHTML = '<i class="fas fa-play mr-1"></i> Run Code';
              },
              function (err) {
                outputElement.textContent = "Error:\n" + err.toString();
                outputElement.classList.remove("bg-gray-700", "text-white");
                outputElement.classList.add("bg-red-900", "text-red-300");
                runButton.innerHTML = '<i class="fas fa-play mr-1"></i> Run Code';
              }
            )
            .finally(() => {
              runButton.disabled = false;
            });
          return;
        }

        mockServerRunner(language, outputElement, runButton);
      }

      document.addEventListener("DOMContentLoaded", function () {
        console.log('=== PAGE LOADING ===');
        console.log('Total Questions:', allQuestionIds.length);
        
        // Load saved states from LocalStorage
        loadStatesFromLocalStorage();

        if (allQuestionIds.length > 0) {
          goToQuestion(allQuestionIds[0]);
        }

        updateQuestionSummary();

        const linkIdFromDjango = "{{ link_id }}";
        const formId = "assessment-form";

        setInterval(() => {
          if (totalSeconds > 0 && !submissionLocked) {
            totalSeconds--;
            updateTimerDisplay(totalSeconds);
          }
          if (totalSeconds <= 0 && !submissionLocked) {
            if (window.pollingInterval) clearInterval(window.pollingInterval);
            lockAndAutoSubmit("time_up");
          }
        }, 1000);

        window.pollingInterval = setInterval(() => {
          if (!submissionLocked) {
            pollTimeRemaining(linkIdFromDjango, formId);
          } else {
            clearInterval(window.pollingInterval);
          }
        }, POLLING_RATE_SECONDS * 1000);

        pollTimeRemaining(linkIdFromDjango, formId);

        require.config({
          paths: {
            vs: "https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs",
          },
        });

        require(["vs/editor/editor.main"], function () {
          console.log("Monaco Editor: Loader script finished loading.");
          document.querySelectorAll(".code-editor").forEach((editorContainer) => {
            const questionId = editorContainer.id.replace("editor-", "");
            const textarea = document.getElementById(`textarea-${questionId}`);

            const languageSelector = document.getElementById(`language-selector-${questionId}`);
            const initialLanguage = languageSelector ? languageSelector.value : "python";

            let monacoLanguage = initialLanguage;
            let initialPlaceholder = "# Write your Python code here";

            switch (initialLanguage) {
              case "javascript":
                monacoLanguage = "javascript";
                initialPlaceholder = "// Write your JavaScript code here";
                break;
              case "java":
                monacoLanguage = "java";
                initialPlaceholder = "// Write your Java code here";
                break;
              case "cpp":
              case "c":
                monacoLanguage = "cpp";
                initialPlaceholder = "// Write your C/C++ code here";
                break;
              case "sql":
                monacoLanguage = "sql";
                initialPlaceholder = "-- Write your SQL query here";
                break;
              default:
                monacoLanguage = "python";
                break;
            }

            editorContainer.setAttribute("data-language", initialLanguage);

            if (!textarea) {
              console.error("Monaco Init Error: Hidden textarea not found for ID:", questionId);
              return;
            }

            if (editorContainer.hasAttribute("data-monaco-initialized")) return;
            editorContainer.setAttribute("data-monaco-initialized", "true");

            try {
              const editor = monaco.editor.create(editorContainer, {
                value: textarea.value || initialPlaceholder,
                language: monacoLanguage,
                theme: "vs-light",
                minimap: { enabled: false },
                automaticLayout: true,
                tabSize: 4,
              });

              editorInstances[questionId] = editor;
              console.log(`Monaco Editor: Initialized editor-${questionId}`);

              editor.onDidChangeModelContent(() => {
                textarea.value = editor.getValue();
                markQuestionAsAnswered(questionId);
              });
            } catch (e) {
              console.error(`Monaco Editor: Failed to create editor-${questionId}`, e);
              editorContainer.textContent = "Error: Editor failed to load. Check your network or browser console.";
            }
          });

          // Load saved answers AFTER Monaco editors are initialized
          setTimeout(() => {
            console.log('Loading answers from LocalStorage...');
            loadAnswersFromLocalStorage();
            updateQuestionSummary();
          }, 1500);
        }, function (err) {
          console.error("Monaco Editor: Main script failed to load.", err);
        });

        document.getElementById("assessment-form").addEventListener("submit", function () {
          if (window.pollingInterval) clearInterval(window.pollingInterval);
          
          // Save final answers before clearing
          saveAnswersToLocalStorage();
          
          // Clear LocalStorage on submit
          clearLocalStorage();

          document.querySelectorAll(".code-editor").forEach((editorContainer) => {
            const questionId = editorContainer.id.replace("editor-", "");
            const textarea = document.getElementById(`textarea-${questionId}`);
            const editor = editorInstances[questionId];

            if (editor) {
              textarea.value = editor.getValue();
            }
          });
        });
      });

      // Auto-save states AND answers every 10 seconds
      setInterval(() => {
        if (!submissionLocked) {
          saveStatesToLocalStorage();
          saveAnswersToLocalStorage();
        }
      }, 10000);
    </script>
  </body>
</html> -->

{% load static %}
<!DOCTYPE html>
<html lang="en" class="bg-slate-50">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Online Test - {{ paper.title }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />

    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/loader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/skulpt/2.0.0/skulpt.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/skulpt/2.0.0/skulpt-stdlib.min.js"></script>
    
    <script type="module">
        // Make GoogleGenAI available to the global scope for the inline scripts
        import { GoogleGenAI } from "https://esm.run/@google/genai";
        window.GoogleGenAI = GoogleGenAI;
    </script>

    <!-- All original script tags for functionality are preserved exactly as they were -->
    <script>
      (function () {
        const windowName = "dedicatedAssessmentWindow";

        if (window.name !== windowName && !window.opener) {
          const url = window.location.href;

          const newWindow = window.open(
            url,
            windowName,
            "width=" +
              screen.availWidth +
              ",height=" +
              screen.availHeight +
              ",resizable=yes,scrollbars=yes,location=no,menubar=no,toolbar=no,status=no"
          );

          if (newWindow) {
            setTimeout(function () {
              window.close();
            }, 50);

            document.body.style.display = "none";
            return;
          }
        }
      })();
    </script>
    <script>
      function noBack() {
        window.history.forward();
      }

      window.history.forward();

      let isNavigating = false;

      document.addEventListener("DOMContentLoaded", function () {
        window.addEventListener("popstate", function (event) {
          alert(
            "âš ï¸ WARNING! Navigation Attempt Detected. The Back/Forward button is disabled for this assessment. Repeated attempts to navigate away may result in auto-submission."
          );

          isNavigating = true;
          noBack();

          setTimeout(() => {
            isNavigating = false;
          }, 500);
        });
      });
    </script>
    <script>
      let editorInstances = {};
      let tabChangeCount = 0;
      const MAX_TAB_CHANGES = 3;
      let submissionLocked = false;

      function lockAndAutoSubmit(reason) {
        if (submissionLocked) return;
        submissionLocked = true;

        if (window.pollingInterval) clearInterval(window.pollingInterval);

        document.title = "Assessment Submitted!";

        const form = document.getElementById("assessment-form");
        const submitButton = form.querySelector('button[type="submit"]');

        const message =
          reason === "time_up"
            ? "ðŸš¨ Time is up! Your assessment is being automatically submitted by the server."
            : "ðŸš¨ FINAL WARNING: You have exceeded the tab change limit. Your assessment is being automatically submitted.";

        if (submitButton) {
          submitButton.disabled = true;
          submitButton.textContent = "Auto-Submitting... ðŸš«";
          submitButton.classList.remove("bg-green-600", "hover:bg-green-700");
          submitButton.classList.add("bg-red-800", "cursor-not-allowed");
        }
        
        const mobileSubmitButton = document.getElementById("mobile-submit-btn");
        if(mobileSubmitButton) {
            mobileSubmitButton.disabled = true;
            mobileSubmitButton.innerHTML = "Auto-Submitting...";
        }

        const timerElement = document.getElementById("timer");
        if (timerElement) {
          timerElement.textContent = "TIME UP";
          timerElement.parentElement.classList.remove('bg-slate-100');
          timerElement.parentElement.classList.add("bg-red-600", "text-white", "animate-pulse");
        }

        alert(message);

        document.querySelectorAll(".code-editor").forEach((editorContainer) => {
          const questionId = editorContainer.id.replace("editor-", "");
          const textarea = document.getElementById(`textarea-${questionId}`);
          const editor = editorInstances[questionId];
          if (editor) {
            textarea.value = editor.getValue();
          }
        });

        form.submit();
      }

      function handleVisibilityChange() {
        if (window.isNavigating || submissionLocked) {
          return;
        }

        const originalTitle = "Online Test - {{ paper.title }}";

        if (document.hidden) {
          document.title = "âš ï¸ Warning: Focus Lost";

          tabChangeCount++;

          if (tabChangeCount <= MAX_TAB_CHANGES) {
            alert(
              `âš ï¸ WARNING! Tab Switched. You have ${
                MAX_TAB_CHANGES - tabChangeCount
              } warnings remaining.`
            );
          } else {
            lockAndAutoSubmit("tab_switch");
          }
        } else {
          document.title = "Focus Regained";
          setTimeout(() => {
            if (!submissionLocked) {
              document.title = originalTitle;
            }
          }, 1000);
        }
      }

      document.addEventListener("visibilitychange", handleVisibilityChange);
    </script>
    <script>
      const OFFLINE_DIALOGUE_ID = "offline-dialogue";

      function showOfflineDialogue() {
        const dialogue = document.getElementById(OFFLINE_DIALOGUE_ID);
        if (dialogue) {
          dialogue.classList.remove("hidden");
        }
      }

      function hideOfflineDialogue() {
        const dialogue = document.getElementById(OFFLINE_DIALOGUE_ID);
        if (dialogue) {
          dialogue.classList.add("hidden");
        }
      }

      function checkConnectionAndHide() {
        if (navigator.onLine) {
          hideOfflineDialogue();
        } else {
          alert(
            "Still offline. Please check your network cables or Wi-Fi connection."
          );
        }
      }

      function handleOnlineStatus() {
        if (navigator.onLine) {
          hideOfflineDialogue();
          console.log("Internet connection restored.");
        } else {
          showOfflineDialogue();
          console.log("Internet connection lost!");
        }
      }

      window.addEventListener("online", handleOnlineStatus);
      window.addEventListener("offline", handleOnlineStatus);

      document.addEventListener("DOMContentLoaded", handleOnlineStatus);
    </script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
                sans: ['Inter', 'sans-serif'],
            },
            colors: {
              primary: {
                DEFAULT: '#4f46e5',
                light: '#6366f1',
                dark: '#4338ca',
              },
              secondary: '#9333ea',
              accent: '#f59e0b',
            },
          },
        },
      };
    </script>
    <style type="text/tailwindcss">
      body {
        font-family: "Inter", sans-serif;
      }

      .code-editor {
        min-height: 300px;
        border: 1px solid #d1d5db; /* cool-gray-300 */
        border-radius: 0.5rem;
        overflow: hidden; /* Ensures rounded corners are applied to the editor content */
      }
      
      .monaco-editor .overflow-guard {
        border-radius: 0.5rem;
      }

      .question-btn {
        @apply w-10 h-10 rounded-md flex items-center justify-center font-bold text-sm cursor-pointer transition-all duration-200 transform hover:scale-110;
      }

      /* State colors for question palette buttons */
      .question-answered {
        @apply bg-emerald-500 text-white shadow-sm border-emerald-600;
      }
      .question-current {
        @apply bg-primary text-white shadow-lg ring-2 ring-offset-2 ring-primary-dark scale-110;
      }
      .question-not-answered {
        @apply bg-rose-500 text-white shadow-sm border-rose-600;
      }
      .question-marked {
        @apply bg-amber-500 text-white shadow-sm border-amber-600;
      }
      .question-not-visited {
        @apply bg-slate-200 text-slate-700 hover:bg-slate-300;
      }

    </style>
  </head>

  <body
    class="text-slate-800 bg-slate-50"
    onload="noBack()"
    onpageshow="if (event.persisted) noBack();"
  >
    <div
      id="offline-dialogue"
      class="fixed inset-0 z-50 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 hidden"
      role="alert"
      aria-modal="true"
      aria-labelledby="dialog-title"
    >
      <div
        class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full"
      >
        <div class="text-center">
          <i class="fas fa-wifi fa-3x text-red-500 mb-4 animate-pulse"></i>
          <h3 id="dialog-title" class="text-2xl font-bold text-slate-900 mb-2">
            Internet Connection Lost
          </h3>
          <p id="dialog-message" class="text-slate-600 mb-6">
            Please check your connection. Your progress is saved locally, but you must be online to submit the test.
          </p>
          <button
            onclick="checkConnectionAndHide()"
            class="w-full bg-primary font-semibold text-white py-3 px-4 rounded-lg hover:bg-primary-dark transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary"
          >
            I'm Back Online
          </button>
        </div>
      </div>
    </div>

    <div class="min-h-screen flex flex-col">
      <header class="bg-white shadow-sm sticky top-0 z-30 border-b border-slate-200">
        <div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                 <h1 class="text-lg md:text-xl font-bold text-slate-800 truncate">
                    {{ paper.title }}
                </h1>
                
                <div class="flex items-center space-x-4">
                    <div class="flex items-center gap-2 bg-slate-100 text-slate-700 font-mono font-bold py-2 px-4 rounded-lg text-lg">
                        <i class="far fa-clock text-primary"></i>
                        <span id="timer">00:00:00</span>
                    </div>
                     <button
                      type="button"
                      onclick="document.getElementById('palette-sidebar').classList.remove('translate-x-full')"
                      class="lg:hidden p-2 rounded-md text-slate-500 hover:text-slate-700 hover:bg-slate-100 focus:outline-none focus:ring-2 focus:ring-primary"
                    >
                      <i class="fas fa-th-large"></i>
                      <span class="sr-only">Open Question Palette</span>
                    </button>
                </div>
            </div>
        </div>
      </header>

      <div class="flex-1 flex min-h-0">
        <form
          method="post"
          action="{% url 'test:user_test' link_id=link_id %}"
          id="assessment-form"
          class="flex-1 flex min-h-0"
        >
          {% csrf_token %}
          
          <main class="flex-1 bg-slate-50 overflow-y-auto p-4 sm:p-6 lg:p-8">
            <div id="questions-container" class="max-w-4xl mx-auto">
              {% for section in sections_list %}
                {% for q in section.questions %}
                  <div 
                    class="question-block bg-white rounded-xl shadow-sm" 
                    id="question-{{ q.id }}" 
                    data-section="{{ section.title }}"
                    data-question-index="{{ forloop.counter }}"
                    style="display: none;">
                    
                    <div class="p-6 border-b border-slate-200">
                      <div class="flex justify-between items-center mb-1">
                        <h2 class="text-sm font-semibold text-primary uppercase tracking-wider">{{ section.title }}</h2>
                        <div class="text-sm font-medium text-slate-500">Question {{ forloop.counter }} of {{ section.questions|length }}</div>
                      </div>
                      <div class="prose max-w-none text-slate-800 mt-4">
                        {{ q.text | safe }}
                      </div>
                    </div>
                    
                    <div class="p-6 bg-slate-50/50">
                        {% if q.type == 'MCQ' %}
                        <div class="space-y-3">
                          {% for option in q.options %}
                          <label class="flex items-start p-4 border-2 border-slate-200 rounded-lg has-[:checked]:border-primary has-[:checked]:bg-primary/5 has-[:checked]:ring-2 has-[:checked]:ring-primary/50 hover:border-primary/70 cursor-pointer transition-all duration-150">
                            <input
                              type="radio"
                              name="question_{{ q.id }}"
                              value="{{ option }}"
                              class="mt-1 h-4 w-4 text-primary border-slate-300 focus:ring-primary"
                              onchange="markQuestionAsAnswered({{ q.id }})"
                            />
                            <span class="ml-4 text-base text-slate-700 flex-1">{{ option }}</span>
                          </label>
                          {% endfor %}
                        </div>
                      {% elif q.type == 'CODE' %}
                        <p class="text-sm text-slate-600 mb-4">
                          Write your code in the editor below. You can run it to test your output.
                        </p>
                        
                        <div class="mb-4">
                          <label
                            for="language-selector-{{ q.id }}"
                            class="text-xs font-semibold text-slate-600 mr-2"
                            >Language:</label
                          >
                          <select
                            id="language-selector-{{ q.id }}"
                            class="py-2 px-3 border border-slate-300 rounded-md text-sm focus:ring-primary focus:border-primary"
                            onchange="changeLanguage({{ q.id }}, this.value)"
                          >
                            <option value="python">Python</option>
                            <option value="javascript">JavaScript</option>
                            <option value="java">Java</option>
                            <option value="cpp">C++</option>
                            <option value="c">C</option>
                            <option value="sql">SQL</option>
                          </select>
                        </div>
                        
                        <div
                          id="editor-{{ q.id }}"
                          class="code-editor mb-4 shadow-inner bg-white"
                          data-language="python"
                        ></div>

                        <textarea
                          name="question_{{ q.id }}"
                          id="textarea-{{ q.id }}"
                          class="hidden"
                        ></textarea>
                        
                        <div class="flex items-center space-x-3 mb-4">
                          <button
                            type="button"
                            id="run-btn-{{ q.id }}"
                            onclick="runCode({{ q.id }})"
                            class="bg-slate-700 text-white font-medium py-2 px-4 rounded-lg hover:bg-slate-800 transition-colors text-sm flex items-center gap-2"
                          >
                            <i class="fas fa-play"></i> Run Code
                          </button>
                        </div>

                        <div
                          id="output-{{ q.id }}"
                          class="hidden mt-3 p-4 text-sm rounded-lg whitespace-pre-wrap font-mono text-left"
                        ></div>
                      {% elif q.type == 'IMAGE' %}
                        <p class="text-sm text-slate-600 mb-4">
                          Read the prompt carefully and generate an image. Your generated image will be submitted as your answer.
                        </p>
                        
                        <div id="image-container-{{ q.id }}" class="mb-4 p-2 border-2 border-dashed border-slate-300 rounded-lg min-h-[256px] flex items-center justify-center bg-slate-100/70">
                            <img id="generated-image-{{ q.id }}" src="" alt="Generated image" class="max-w-full max-h-96 rounded-md hidden object-contain"/>
                            <div id="image-placeholder-{{ q.id }}" class="text-center text-slate-500">
                                <i class="fas fa-image fa-2x mb-2 text-slate-400"></i>
                                <p>Your generated image will appear here</p>
                            </div>
                        </div>

                        <textarea
                          name="question_{{ q.id }}"
                          id="textarea-{{ q.id }}"
                          class="hidden"
                        ></textarea>
                        
                        <div class="flex items-center space-x-3">
                          <button
                            type="button"
                            id="generate-btn-{{ q.id }}"
                            onclick="generateImage({{ q.id }}, '{{ q.text | escapejs }}')"
                            class="bg-sky-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-sky-700 transition-colors text-sm flex items-center gap-2"
                          >
                            <i class="fas fa-magic"></i> Generate Image
                          </button>
                        </div>
                      {% else %}
                        <textarea
                          name="question_{{ q.id }}"
                          id="textarea-{{ q.id }}"
                          rows="8"
                          placeholder="Type your detailed answer here..."
                          class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary resize-y"
                          onchange="markQuestionAsAnswered({{ q.id }})"
                        ></textarea>
                      {% endif %}
                    </div>

                    <div class="flex justify-between items-center p-4 border-t border-slate-200 bg-white rounded-b-xl">
                      <button
                        type="button"
                        onclick="markForReviewCurrent()"
                        id="mark-review-btn-{{ q.id }}"
                        class="bg-purple-100 text-purple-700 font-semibold py-2 px-5 rounded-lg hover:bg-purple-200 transition-colors text-sm flex items-center gap-2"
                      >
                       <i class="far fa-bookmark"></i> Mark for review
                      </button>
                      
                      <div class="flex space-x-3">
                        <button
                          type="button"
                          onclick="previousQuestion()"
                          class="bg-slate-200 text-slate-700 font-semibold py-2 px-5 rounded-lg hover:bg-slate-300 transition-colors text-sm"
                        >
                          Previous
                        </button>
                        <button
                          type="button"
                          onclick="nextQuestion()"
                          class="bg-primary text-white font-semibold py-2 px-5 rounded-lg hover:bg-primary-dark transition-colors text-sm"
                        >
                          Next
                        </button>
                      </div>
                    </div>

                  </div>
                {% endfor %}
              {% endfor %}
            </div>
          </main>

          <!-- Desktop Sidebar -->
          <aside class="w-80 bg-white border-l border-slate-200 overflow-y-auto p-6 hidden lg:block">
            <div class="space-y-6">
                {% for section in sections_list %}
                <div>
                  <h3 class="font-bold text-slate-800 mb-3 text-sm uppercase tracking-wide">{{ section.title }}</h3>
                  <div class="grid grid-cols-5 gap-3">
                    {% for q in section.questions %}
                    <div
                      class="question-btn question-not-visited"
                      id="palette-btn-{{ q.id }}"
                      data-question-id="{{ q.id }}"
                      onclick="goToQuestion({{ q.id }})"
                    >
                      {{ forloop.counter }}
                    </div>
                    {% endfor %}
                  </div>
                </div>
                {% endfor %}
            </div>
            
            <div class="mt-8 pt-6 border-t border-slate-200">
                <h4 class="font-bold text-slate-800 mb-4 text-sm uppercase tracking-wide">Legend</h4>
                <div class="space-y-3">
                    <div class="flex justify-between items-center text-sm">
                        <div class="flex items-center gap-3"><div class="w-4 h-4 rounded-full bg-emerald-500"></div>Answered</div>
                        <span id="count-answered" class="font-bold text-slate-600 bg-slate-100 px-2 py-0.5 rounded-full">0</span>
                    </div>
                    <div class="flex justify-between items-center text-sm">
                        <div class="flex items-center gap-3"><div class="w-4 h-4 rounded-full bg-rose-500"></div>Not Answered</div>
                        <span id="count-not-answered" class="font-bold text-slate-600 bg-slate-100 px-2 py-0.5 rounded-full">0</span>
                    </div>
                    <div class="flex justify-between items-center text-sm">
                        <div class="flex items-center gap-3"><div class="w-4 h-4 rounded-full bg-slate-200"></div>Not Visited</div>
                        <span id="count-not-visited" class="font-bold text-slate-600 bg-slate-100 px-2 py-0.5 rounded-full">0</span>
                    </div>
                    <div class="flex justify-between items-center text-sm">
                        <div class="flex items-center gap-3"><div class="w-4 h-4 rounded-full bg-amber-500"></div>Marked for Review</div>
                        <span id="count-marked" class="font-bold text-slate-600 bg-slate-100 px-2 py-0.5 rounded-full">0</span>
                    </div>
                    <div class="flex justify-between items-center text-sm">
                        <div class="flex items-center gap-3"><div class="w-4 h-4 rounded-full bg-primary ring-2 ring-primary/50"></div>Current</div>
                        <span id="count-current" class="font-bold text-slate-600 bg-slate-100 px-2 py-0.5 rounded-full">0</span>
                    </div>
                </div>
            </div>

            <div class="mt-8 sticky bottom-6">
              <button
                type="submit"
                class="w-full bg-emerald-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-emerald-700 transition-colors shadow-lg shadow-emerald-500/30 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500"
              >
                Submit Test
              </button>
            </div>
          </aside>
          
          <!-- Mobile Off-canvas Sidebar -->
          <div id="palette-sidebar" class="fixed inset-0 z-40 lg:hidden transform translate-x-full transition-transform duration-300 ease-in-out">
            <div class="absolute inset-0 bg-black/40" onclick="this.parentElement.classList.add('translate-x-full')"></div>
            <div class="absolute right-0 top-0 bottom-0 w-80 bg-white border-l border-slate-200 overflow-y-auto p-6">
                <button
                  type="button"
                  onclick="this.parentElement.parentElement.classList.add('translate-x-full')"
                  class="absolute top-4 right-4 p-2 rounded-md text-slate-500 hover:text-slate-700 hover:bg-slate-100"
                >
                  <i class="fas fa-times"></i>
                  <span class="sr-only">Close Palette</span>
                </button>
                <div class="mt-8 space-y-6">
                    {% for section in sections_list %}
                    <div>
                      <h3 class="font-bold text-slate-800 mb-3 text-sm uppercase tracking-wide">{{ section.title }}</h3>
                      <div class="grid grid-cols-5 gap-3">
                        {% for q in section.questions %}
                        <div
                          class="question-btn question-not-visited"
                          id="palette-btn-{{ q.id }}-mobile"
                          data-question-id="{{ q.id }}"
                          onclick="goToQuestion({{ q.id }}); document.getElementById('palette-sidebar').classList.add('translate-x-full')"
                        >
                          {{ forloop.counter }}
                        </div>
                        {% endfor %}
                      </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
          </div>

        </form>
      </div>
      
       <!-- Mobile Bottom Bar -->
       <footer class="lg:hidden sticky bottom-0 z-20 bg-white border-t border-slate-200 shadow-lg p-2">
            <div class="flex justify-between items-center gap-2">
                <button type="button" onclick="previousQuestion()" class="flex-1 text-center bg-slate-200 text-slate-700 font-semibold py-3 rounded-lg hover:bg-slate-300 transition-colors text-sm">Previous</button>
                <button type="submit" id="mobile-submit-btn" class="flex-1 text-center bg-emerald-600 text-white font-semibold py-3 rounded-lg hover:bg-emerald-700 transition-colors text-sm shadow-md shadow-emerald-500/30">Submit</button>
                <button type="button" onclick="nextQuestion()" class="flex-1 text-center bg-primary text-white font-semibold py-3 rounded-lg hover:bg-primary-dark transition-colors text-sm">Next</button>
            </div>
       </footer>

    </div>

    <!-- All original script tags for functionality are preserved exactly as they were -->
    <script>
      // --- Enhanced LocalStorage Functions for Answers & States ---
      const STORAGE_KEY = `test_states_{{ link_id }}`;
      const ANSWERS_STORAGE_KEY = `test_answers_{{ link_id }}`;

      function saveStatesToLocalStorage() {
        try {
          const statesToSave = {};
          allQuestionIds.forEach(qId => {
            statesToSave[qId] = questionStates[qId];
          });
          localStorage.setItem(STORAGE_KEY, JSON.stringify(statesToSave));
        } catch (e) {
          console.error('Error saving states to LocalStorage:', e);
        }
      }

      function loadStatesFromLocalStorage() {
        try {
          const savedStates = localStorage.getItem(STORAGE_KEY);
          if (savedStates) {
            const parsedStates = JSON.parse(savedStates);
            allQuestionIds.forEach(qId => {
              if (parsedStates[qId]) {
                questionStates[qId] = parsedStates[qId];
              }
            });
            return true;
          }
        } catch (e) {
          console.error('Error loading states from LocalStorage:', e);
        }
        return false;
      }

      function saveAnswersToLocalStorage() {
        try {
          const answersToSave = {};
          
          allQuestionIds.forEach(qId => {
            const radioInput = document.querySelector(`input[name="question_${qId}"]:checked`);
            if (radioInput) {
              answersToSave[qId] = {
                type: 'mcq',
                value: radioInput.value
              };
            }
            
            const textarea = document.querySelector(`textarea[name="question_${qId}"]`);
            // Also check for image answers stored in the textarea
            if (textarea && textarea.value && !editorInstances[qId]) {
              answersToSave[qId] = {
                type: 'textarea', // Could be 'image' or 'text', but 'textarea' is a safe generic
                value: textarea.value
              };
            }
            
            const editor = editorInstances[qId];
            if (editor) {
              answersToSave[qId] = {
                type: 'code',
                value: editor.getValue()
              };
            }
          });
          
          localStorage.setItem(ANSWERS_STORAGE_KEY, JSON.stringify(answersToSave));
        } catch (e) {
          console.error('Error saving answers to LocalStorage:', e);
        }
      }

      function loadAnswersFromLocalStorage() {
        try {
          const savedAnswers = localStorage.getItem(ANSWERS_STORAGE_KEY);
          if (savedAnswers) {
            const parsedAnswers = JSON.parse(savedAnswers);
            
            Object.keys(parsedAnswers).forEach(qId => {
              const answer = parsedAnswers[qId];
              
              try {
                if (answer.type === 'mcq') {
                  const radioInput = document.querySelector(`input[name="question_${qId}"][value="${answer.value}"]`);
                  if (radioInput) {
                    radioInput.checked = true;
                  }
                } else if (answer.type === 'textarea') {
                  const textarea = document.querySelector(`textarea[name="question_${qId}"]`);
                   if (textarea && !editorInstances[qId]) {
                    // This could be a plain text answer or a base64 image string.
                    // If it's an image string, let's try to render it.
                    if (answer.value.startsWith('iVBORw0KGgo') || answer.value.startsWith('/9j/')) {
                         const imageEl = document.getElementById(`generated-image-${qId}`);
                         const placeholderEl = document.getElementById(`image-placeholder-${qId}`);
                         if (imageEl && placeholderEl) {
                            imageEl.src = `data:image/jpeg;base64,${answer.value}`;
                            textarea.value = answer.value;
                            imageEl.classList.remove('hidden');
                            placeholderEl.classList.add('hidden');
                         }
                    } else {
                        textarea.value = answer.value;
                    }
                  }
                } else if (answer.type === 'code') {
                  const editor = editorInstances[qId];
                  if (editor) {
                    editor.setValue(answer.value);
                  }
                }
              } catch (err) {
                console.error(`Error restoring answer for question ${qId}:`, err);
              }
            });
            return true;
          }
        } catch (e) {
          console.error('Error loading answers from LocalStorage:', e);
        }
        return false;
      }

      function clearLocalStorage() {
        try {
          localStorage.removeItem(STORAGE_KEY);
          localStorage.removeItem(ANSWERS_STORAGE_KEY);
        } catch (e) {
          console.error('Error clearing LocalStorage:', e);
        }
      }

      // --- Question Navigation State ---
      let currentQuestionId = null;
      let questionStates = {};
      let allQuestionIds = [];

      {% for section in sections_list %}
        {% for q in section.questions %}
          allQuestionIds.push({{ q.id }});
          questionStates[{{ q.id }}] = {
            answered: false,
            marked: false,
            visited: false
          };
        {% endfor %}
      {% endfor %}

      function goToQuestion(questionId) {
        document.querySelectorAll('.question-block').forEach(block => {
          block.style.display = 'none';
        });

        const questionBlock = document.getElementById(`question-${questionId}`);
        if (questionBlock) {
          questionBlock.style.display = 'block';
          currentQuestionId = questionId;
          questionStates[questionId].visited = true;
          saveStatesToLocalStorage();
          updateQuestionPalette();
          updateNavigationButtons();
          updateQuestionSummary();
          updateMarkReviewButton(questionId);
        }
      }

      function nextQuestion() {
        const currentIndex = allQuestionIds.indexOf(currentQuestionId);
        if (currentIndex < allQuestionIds.length - 1) {
          const nextId = allQuestionIds[currentIndex + 1];
          goToQuestion(nextId);
        }
      }

      function previousQuestion() {
        const currentIndex = allQuestionIds.indexOf(currentQuestionId);
        if (currentIndex > 0) {
          const prevId = allQuestionIds[currentIndex - 1];
          goToQuestion(prevId);
        }
      }

      function updateNavigationButtons() {
        const currentIndex = allQuestionIds.indexOf(currentQuestionId);
        
        // Desktop buttons
        const desktopPrev = document.querySelector(`#question-${currentQuestionId} button[onclick^="previousQuestion"]`);
        const desktopNext = document.querySelector(`#question-${currentQuestionId} button[onclick^="nextQuestion"]`);
        
        // Mobile buttons in footer
        const mobilePrev = document.querySelector('footer button[onclick^="previousQuestion"]');
        const mobileNext = document.querySelector('footer button[onclick^="nextQuestion"]');

        const allPrevButtons = [desktopPrev, mobilePrev].filter(Boolean);
        const allNextButtons = [desktopNext, mobileNext].filter(Boolean);
        
        allPrevButtons.forEach(btn => {
            if (currentIndex === 0) {
              btn.disabled = true;
              btn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
              btn.disabled = false;
              btn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        });

        allNextButtons.forEach(btn => {
            if (currentIndex === allQuestionIds.length - 1) {
              btn.disabled = true;
              btn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
              btn.disabled = false;
              btn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        });
      }

      function markQuestionAsAnswered(questionId) {
        questionStates[questionId].answered = true;
        questionStates[questionId].marked = false;
        saveStatesToLocalStorage();
        saveAnswersToLocalStorage();
        updateQuestionPalette();
        updateQuestionSummary();
      }

      function markForReview(questionId) {
        questionStates[questionId].marked = !questionStates[questionId].marked;
        saveStatesToLocalStorage();
        saveAnswersToLocalStorage();
        updateQuestionPalette();
        updateQuestionSummary();
        updateMarkReviewButton(questionId);
      }

      function markForReviewCurrent() {
        if (currentQuestionId) {
          markForReview(currentQuestionId);
        } else {
          console.error('No current question selected');
        }
      }

      function updateMarkReviewButton(questionId) {
        const btn = document.getElementById(`mark-review-btn-${questionId}`);
        if (btn) {
          if (questionStates[questionId].marked) {
            btn.innerHTML = `<i class="fas fa-bookmark"></i> Unmark Review`;
            btn.classList.remove('bg-purple-100', 'text-purple-700', 'hover:bg-purple-200');
            btn.classList.add('bg-amber-100', 'text-amber-700', 'hover:bg-amber-200');
          } else {
            btn.innerHTML = `<i class="far fa-bookmark"></i> Mark for review`;
            btn.classList.remove('bg-amber-100', 'text-amber-700', 'hover:bg-amber-200');
            btn.classList.add('bg-purple-100', 'text-purple-700', 'hover:bg-purple-200');
          }
        }
      }

      function updateQuestionPalette() {
        allQuestionIds.forEach(qId => {
          const desktopBtn = document.getElementById(`palette-btn-${qId}`);
          const mobileBtn = document.getElementById(`palette-btn-${qId}-mobile`);
          const buttons = [desktopBtn, mobileBtn].filter(Boolean);

          buttons.forEach(btn => {
              btn.classList.remove('question-answered', 'question-current', 'question-not-answered', 'question-marked', 'question-not-visited');
              if (qId === currentQuestionId) {
                  btn.classList.add('question-current');
              } else if (questionStates[qId].marked) {
                  btn.classList.add('question-marked');
              } else if (questionStates[qId].answered) {
                  btn.classList.add('question-answered');
              } else if (questionStates[qId].visited) {
                  btn.classList.add('question-not-answered');
              } else {
                  btn.classList.add('question-not-visited');
              }
          });
        });
      }

      function updateQuestionSummary() {
        let counts = {
          answered: 0,
          notAnswered: 0,
          notVisited: 0,
          marked: 0,
          current: 0
        };

        allQuestionIds.forEach(qId => {
            if (questionStates[qId].marked) {
                counts.marked++;
            } else if (questionStates[qId].answered) {
                counts.answered++;
            } else if (questionStates[qId].visited) {
                counts.notAnswered++;
            } else {
                counts.notVisited++;
            }
        });
        counts.current = currentQuestionId ? 1 : 0;
        
        document.getElementById('count-answered').textContent = counts.answered;
        document.getElementById('count-not-answered').textContent = counts.notAnswered;
        document.getElementById('count-not-visited').textContent = counts.notVisited;
        document.getElementById('count-marked').textContent = counts.marked;
        document.getElementById('count-current').textContent = counts.current;
      }

      // --- TIMER LOGIC VARIABLES ---
      let totalSeconds = -1;
      const POLLING_RATE_SECONDS = 15;
      window.pollingInterval = null;
      window.editorInstances = {};

      function formatTime(seconds) {
        if (seconds < 0) seconds = 0;
        let hours = Math.floor(seconds / 3600);
        let minutes = Math.floor((seconds % 3600) / 60);
        let secs = Math.floor(seconds % 60);

        hours = hours < 10 ? "0" + hours : hours;
        minutes = minutes < 10 ? "0" + minutes : minutes;
        secs = secs < 10 ? "0" + secs : secs;

        return hours + ":" + minutes + ":" + secs;
      }

      function updateTimerDisplay(seconds) {
        let timerElement = document.getElementById("timer");
        if (!timerElement) return;

        timerElement.textContent = formatTime(seconds);
        const parentDiv = timerElement.parentElement;
        parentDiv.classList.remove("bg-amber-100", "text-amber-800", "bg-red-100", "text-red-800");

        if (seconds <= 60) {
          parentDiv.classList.add("bg-red-100", "text-red-800");
        } else if (seconds <= 300) {
          parentDiv.classList.add("bg-amber-100", "text-amber-800");
        }
      }

      function pollTimeRemaining() {
        const timeUrl = "{% url 'test:get_time_remaining_api' link_id=link_id %}";
        fetch(timeUrl)
          .then(response => response.ok ? response.json() : Promise.reject("Server Time API response not ok"))
          .then(data => {
            if (data.error) {
              console.error("Server Time Error:", data.error);
              if (window.pollingInterval) clearInterval(window.pollingInterval);
              return;
            }
            totalSeconds = data.remaining_seconds;
            if (data.time_up || totalSeconds <= 0) {
              if (window.pollingInterval) clearInterval(window.pollingInterval);
              lockAndAutoSubmit("time_up");
            } else {
              updateTimerDisplay(totalSeconds);
            }
          })
          .catch(error => console.error("Fetch Error:", error));
      }

      async function generateImage(questionId, prompt) {
        const genButton = document.getElementById(`generate-btn-${questionId}`);
        const imageEl = document.getElementById(`generated-image-${questionId}`);
        const placeholderEl = document.getElementById(`image-placeholder-${questionId}`);
        const textarea = document.getElementById(`textarea-${questionId}`);
        
        if (!window.GoogleGenAI) {
            alert('Image generation library is not available. Please check your internet connection and refresh.');
            return;
        }

        try {
            genButton.disabled = true;
            genButton.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Generating...`;
            placeholderEl.innerHTML = `
                <div class="text-center text-slate-500">
                    <i class="fas fa-circle-notch fa-spin fa-2x mb-2 text-slate-400"></i>
                    <p>Generating, this may take a moment...</p>
                </div>
            `;
            imageEl.classList.add('hidden');
            placeholderEl.classList.remove('hidden');
            
            // Per guidelines, API key must be from process.env.API_KEY
            const ai = new window.GoogleGenAI({ apiKey: process.env.API_KEY });
            const response = await ai.models.generateImages({
                model: 'imagen-4.0-generate-001',
                prompt: prompt,
                config: {
                  numberOfImages: 1,
                  outputMimeType: 'image/jpeg',
                  aspectRatio: '1:1',
                },
            });
            
            const base64ImageBytes = response.generatedImages[0].image.imageBytes;
            const imageUrl = `data:image/jpeg;base64,${base64ImageBytes}`;
            
            imageEl.src = imageUrl;
            textarea.value = base64ImageBytes; // Store base64 data for submission
            
            imageEl.classList.remove('hidden');
            placeholderEl.classList.add('hidden');
            
            markQuestionAsAnswered(questionId);
            
            genButton.innerHTML = `<i class="fas fa-sync-alt"></i> Regenerate`;

        } catch (error) {
            console.error('Error generating image:', error);
            placeholderEl.innerHTML = `
                <div class="text-center text-red-500">
                    <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                    <p>Error: Could not generate image.</p>
                </div>
            `;
            alert('An error occurred while generating the image. Please ensure your API key is configured correctly and check the console for details.');
        } finally {
            genButton.disabled = false;
        }
      }

      function outf(text, questionId) {
        const outputElement = document.getElementById(`output-${questionId}`);
        outputElement.textContent += text;
        outputElement.classList.remove("hidden");
        outputElement.classList.remove("bg-red-100", "text-red-800");
        outputElement.classList.add("bg-slate-800", "text-emerald-300");
      }

      function builtinRead(x) {
        if (Sk.builtinFiles?.files?.[x] === undefined) throw "File not found: '" + x + "'";
        return Sk.builtinFiles["files"][x];
      }

      function runJavaScript(code, outputElement, runButton) {
        let output = "";
        const originalConsoleLog = console.log;
        console.log = (...args) => { output += args.map(String).join(" ") + "\n"; };

        try {
          new Function(code)();
          outputElement.textContent = output.trim() || "Code executed with no console output.";
          outputElement.classList.remove("bg-red-100", "text-red-800", "bg-sky-100", "text-sky-800");
          outputElement.classList.add("bg-slate-800", "text-emerald-300");
        } catch (err) {
          outputElement.textContent = "Error:\n" + err.toString();
          outputElement.classList.remove("bg-slate-800", "text-emerald-300", "bg-sky-100", "text-sky-800");
          outputElement.classList.add("bg-red-100", "text-red-800");
        } finally {
          console.log = originalConsoleLog;
          runButton.innerHTML = '<i class="fas fa-play"></i> Run Code';
          runButton.disabled = false;
        }
      }

      function mockServerRunner(language, outputElement, runButton) {
        outputElement.textContent = `NOTE: ${language.toUpperCase()} code is not run in the browser.\nYour code is saved and will be fully evaluated on the server upon submission.`;
        outputElement.classList.remove("bg-red-100", "text-red-800", "bg-slate-800", "text-emerald-300");
        outputElement.classList.add("bg-sky-100", "text-sky-800");
        setTimeout(() => {
          runButton.innerHTML = '<i class="fas fa-play"></i> Run Code';
          runButton.disabled = false;
        }, 500);
      }

      function changeLanguage(questionId, newLanguage) {
        const editor = editorInstances[questionId];
        const editorContainer = document.getElementById(`editor-${questionId}`);
        if (!editor) return;

        let monacoLanguage = newLanguage;
        let placeholder = "// Write your code here";

        switch (newLanguage) {
          case "python": placeholder = "# Write your Python code here"; break;
          case "javascript": monacoLanguage = "javascript"; placeholder = "// Write your JavaScript code here"; break;
          case "java": monacoLanguage = "java"; placeholder = "// Write your Java code here"; break;
          case "cpp": case "c": monacoLanguage = "cpp"; placeholder = "// Write your C/C++ code here"; break;
          case "sql": monacoLanguage = "sql"; placeholder = "-- Write your SQL query here"; break;
          default: monacoLanguage = "plaintext"; break;
        }

        monaco.editor.setModelLanguage(editor.getModel(), monacoLanguage);
        editorContainer.setAttribute("data-language", newLanguage);

        const currentValue = editor.getValue().trim();
        if (currentValue === "" || currentValue.startsWith("# Write") || currentValue.startsWith("// Write") || currentValue.startsWith("-- Write")) {
          editor.setValue(placeholder);
        }
      }

      function runCode(questionId) {
        const editor = editorInstances[questionId];
        if (!editor) return;

        const code = editor.getValue();
        const outputElement = document.getElementById(`output-${questionId}`);
        const runButton = document.getElementById(`run-btn-${questionId}`);
        const language = document.getElementById(`editor-${questionId}`).getAttribute("data-language") || "python";

        outputElement.textContent = "Running...";
        outputElement.classList.remove("hidden", "bg-red-100", "text-red-800", "bg-slate-800", "text-emerald-300", "bg-sky-100", "text-sky-800");
        outputElement.classList.add("bg-slate-100", "text-slate-700");
        runButton.disabled = true;
        runButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Running...';

        if (language === "javascript") {
          runJavaScript(code, outputElement, runButton);
        } else if (language === "python") {
          Sk.pre = `output-${questionId}`;
          Sk.configure({ output: (text) => outf(text, questionId), read: builtinRead, execLimit: 5000 });
          Sk.misceval.asyncToPromise(() => Sk.importMainWithBody("<stdin>", false, code, true))
            .then(
              () => runButton.innerHTML = '<i class="fas fa-play"></i> Run Code',
              (err) => {
                outputElement.textContent = "Error:\n" + err.toString();
                outputElement.classList.remove("bg-slate-800", "text-emerald-300");
                outputElement.classList.add("bg-red-100", "text-red-800");
                runButton.innerHTML = '<i class="fas fa-play"></i> Run Code';
              }
            )
            .finally(() => runButton.disabled = false);
        } else {
          mockServerRunner(language, outputElement, runButton);
        }
      }

      document.addEventListener("DOMContentLoaded", function () {
        loadStatesFromLocalStorage();
        if (allQuestionIds.length > 0) goToQuestion(allQuestionIds[0]);
        updateQuestionSummary();

        setInterval(() => {
          if (totalSeconds > 0 && !submissionLocked) {
            totalSeconds--;
            updateTimerDisplay(totalSeconds);
          }
          if (totalSeconds <= 0 && !submissionLocked) {
            clearInterval(window.pollingInterval);
            lockAndAutoSubmit("time_up");
          }
        }, 1000);

        window.pollingInterval = setInterval(() => {
          if (!submissionLocked) pollTimeRemaining();
          else clearInterval(window.pollingInterval);
        }, POLLING_RATE_SECONDS * 1000);

        pollTimeRemaining();

        require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs' } });
        require(["vs/editor/editor.main"], function () {
          document.querySelectorAll(".code-editor").forEach((container) => {
            const questionId = container.id.replace("editor-", "");
            const textarea = document.getElementById(`textarea-${questionId}`);
            const langSelector = document.getElementById(`language-selector-${questionId}`);
            const initialLang = langSelector ? langSelector.value : "python";

            let monacoLang = initialLang, placeholder = "# Write your Python code here";
            switch(initialLang) {
                case "javascript": monacoLang="javascript"; placeholder="// Write your JavaScript code here"; break;
                case "java": monacoLang="java"; placeholder="// Write your Java code here"; break;
                case "cpp": case "c": monacoLang="cpp"; placeholder="// Write your C/C++ code here"; break;
                case "sql": monacoLang="sql"; placeholder="-- Write your SQL query here"; break;
            }
            container.setAttribute("data-language", initialLang);
            if (!textarea || container.hasAttribute("data-monaco-initialized")) return;
            container.setAttribute("data-monaco-initialized", "true");

            try {
              const editor = monaco.editor.create(container, {
                value: textarea.value || placeholder,
                language: monacoLang,
                theme: "vs-light",
                minimap: { enabled: false },
                automaticLayout: true,
                fontSize: 14,
                wordWrap: 'on',
                roundedSelection: false,
                scrollBeyondLastLine: false,
              });
              editorInstances[questionId] = editor;
              editor.onDidChangeModelContent(() => {
                textarea.value = editor.getValue();
                markQuestionAsAnswered(questionId);
              });
            } catch (e) {
              console.error(`Monaco Editor failed for editor-${questionId}`, e);
              container.textContent = "Error: Editor failed to load.";
            }
          });
          
          setTimeout(() => loadAnswersFromLocalStorage() && updateQuestionSummary(), 1000);
        }, err => console.error("Monaco Editor failed to load.", err));

        document.getElementById("assessment-form").addEventListener("submit", function () {
          if (window.pollingInterval) clearInterval(window.pollingInterval);
          saveAnswersToLocalStorage();
          clearLocalStorage();
          document.querySelectorAll(".code-editor").forEach((container) => {
            const questionId = container.id.replace("editor-", "");
            const textarea = document.getElementById(`textarea-${questionId}`);
            const editor = editorInstances[questionId];
            if (editor) textarea.value = editor.getValue();
          });
        });
      });

      // Auto-save progress
      setInterval(() => {
        if (!submissionLocked) {
          saveStatesToLocalStorage();
          saveAnswersToLocalStorage();
        }
      }, 10000);
    </script>
  </body>
</html>